<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda de Tatuagem</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/locale/pt-br.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Ativar logs do Firebase para depura√ß√£o
        setLogLevel('Debug');

        // Vari√°veis globais
        // Verifica√ß√£o para garantir que o c√≥digo funcione em qualquer lugar
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'demo-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app;
        let db;
        let auth;
        let userId;
        let firebaseReady = false;

        const appState = {
            currentView: 'auth',
            currentDate: dayjs(),
            selectedDate: dayjs(),
            clients: [],
            appointments: [],
            isClientFormVisible: false,
            isAppointmentModalVisible: false,
            editingAppointment: null,
            editingClient: null,
            isLoaded: false,
            appointmentsCount: 0,
            isPaid: false,
        };

        dayjs.locale('pt-br');

        const bodyParts = [
            "Bra√ßo (Completo)", "Bra√ßo (Antebra√ßo)", "Bra√ßo (B√≠ceps)", "Perna (Completa)",
            "Perna (Panturrilha)", "Perna (Coxa)", "Costas", "Peito", "Ombro",
            "M√£o", "P√©", "Pesco√ßo", "Outra"
        ];
        
        // Inicializar Firebase apenas se a configura√ß√£o estiver dispon√≠vel
        if (firebaseConfig) {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                firebaseReady = true;
                if (initialAuthToken) {
                    signInWithCustomToken(auth, initialAuthToken).catch(console.error);
                } else {
                    signInAnonymously(auth).catch(console.error);
                }
            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
            }
        } else {
            console.warn("Firebase n√£o inicializado. Rodando em modo de demonstra√ß√£o.");
        }


        // Fun√ß√µes utilit√°rias
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const messageEl = document.getElementById('notification-message');
            messageEl.textContent = message;
            notification.className = `p-4 m-4 rounded-xl shadow-lg fixed bottom-4 right-4 z-50 text-white transition-opacity duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            notification.classList.remove('opacity-0', 'invisible');
            setTimeout(() => {
                notification.classList.add('opacity-0', 'invisible');
            }, 3000);
        }

        function openImageModal(imageUrl) {
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4";
            modal.innerHTML = `
                <div class="relative w-full h-full max-w-full max-h-full">
                    <button class="absolute top-4 right-4 text-white text-4xl p-2 z-50 hover:text-gray-400">&times;</button>
                    <img src="${imageUrl}" class="w-full h-full object-contain rounded-xl" alt="Imagem de refer√™ncia">
                </div>
            `;
            document.body.appendChild(modal);
            modal.querySelector('button').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
        }

        // Fun√ß√µes do Firebase (com verifica√ß√£o)
        async function fetchAppointments() {
            if (!firebaseReady || !userId) { 
                console.warn("Firebase n√£o est√° pronto. Pulando a busca de agendamentos."); 
                // Exemplo de dados para a demonstra√ß√£o
                appState.appointments = [{
                    id: 'demo-1',
                    clientId: 'demo-1',
                    date: dayjs().add(1, 'day').hour(10).minute(0).toISOString(),
                    bodyPart: 'Bra√ßo (Antebra√ßo)',
                    depositPaid: true,
                    referenceImage: 'https://placehold.co/100x100'
                }];
                appState.appointmentsCount = appState.appointments.length;
                render();
                return; 
            }
            const q = collection(db, `artifacts/${appId}/users/${userId}/appointments`);
            onSnapshot(q, (snapshot) => {
                const appointments = [];
                snapshot.forEach(doc => appointments.push({ id: doc.id, ...doc.data() }));
                appState.appointments = appointments;
                appState.appointmentsCount = appointments.length;
                render();
            });
        }

        async function fetchClients() {
            if (!firebaseReady || !userId) { 
                console.warn("Firebase n√£o est√° pronto. Pulando a busca de clientes."); 
                // Exemplo de dados para a demonstra√ß√£o
                appState.clients = [{
                    id: 'demo-1',
                    name: 'Jo√£o Demo',
                    contact: 'joao.demo@email.com',
                    totalValue: 'R$ 500'
                }];
                render();
                return; 
            }
            const q = collection(db, `artifacts/${appId}/users/${userId}/clients`);
            onSnapshot(q, (snapshot) => {
                const clients = [];
                snapshot.forEach(doc => clients.push({ id: doc.id, ...doc.data() }));
                appState.clients = clients;
                render();
            });
        }
        
        async function fetchPaymentStatus() {
            if (!firebaseReady || !userId) return;
            const userDocRef = doc(db, `artifacts/${appId}/users/${userId}/private/profile`);
            try {
                const userDoc = await getDoc(userDocRef);
                if (userDoc.exists()) {
                    appState.isPaid = userDoc.data().isPaid || false;
                }
            } catch (e) {
                console.error("Erro ao buscar status de pagamento: ", e);
            }
        }

        async function saveClient(clientData) {
            if (!firebaseReady || !userId) return showNotification('Modo de demonstra√ß√£o: n√£o √© poss√≠vel salvar dados.', 'error');
            try {
                if (clientData.id) {
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/clients`, clientData.id), clientData);
                    showNotification('Cliente atualizado com sucesso!');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/clients`), clientData);
                    showNotification('Cliente salvo com sucesso!');
                }
            } catch (e) {
                console.error("Erro ao salvar cliente: ", e);
                showNotification('Erro ao salvar cliente.', 'error');
            }
        }

        async function saveAppointment(appointmentData) {
            if (!firebaseReady || !userId) return showNotification('Modo de demonstra√ß√£o: n√£o √© poss√≠vel salvar dados.', 'error');

            if (!appState.isPaid && appState.appointmentsCount >= 10 && !appState.editingAppointment) {
                appState.isAppointmentModalVisible = false;
                showPaywall();
                return;
            }

            try {
                if (appointmentData.id) {
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/appointments`, appointmentData.id), appointmentData);
                    showNotification('Agendamento atualizado com sucesso!');
                } else {
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/appointments`), appointmentData);
                    showNotification('Agendamento salvo com sucesso!');
                }
            } catch (e) {
                console.error("Erro ao salvar agendamento: ", e);
                showNotification('Erro ao salvar agendamento.', 'error');
            }
        }

        async function deleteAppointment(id) {
            if (!firebaseReady || !userId) return showNotification('Modo de demonstra√ß√£o: n√£o √© poss√≠vel excluir dados.', 'error');
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/appointments`, id));
                showNotification('Agendamento exclu√≠do com sucesso!');
            } catch (e) {
                console.error("Erro ao excluir agendamento: ", e);
                showNotification('Erro ao excluir agendamento.', 'error');
            }
        }

        async function deleteClient(id) {
            if (!firebaseReady || !userId) return showNotification('Modo de demonstra√ß√£o: n√£o √© poss√≠vel excluir dados.', 'error');
            try {
                const appointmentsQuery = query(collection(db, `artifacts/${appId}/users/${userId}/appointments`), where("clientId", "==", id));
                const appointmentsSnapshot = await getDocs(appointmentsQuery);
                const deletePromises = appointmentsSnapshot.docs.map(doc => deleteDoc(doc.ref));
                await Promise.all(deletePromises);
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/clients`, id));
                showNotification('Cliente e seus agendamentos foram exclu√≠dos com sucesso!');
            } catch (e) {
                console.error("Erro ao excluir cliente:", e);
                showNotification('Erro ao excluir cliente.', 'error');
            }
        }

        // Fun√ß√µes de Renderiza√ß√£o
        function render() {
            const appContainer = document.getElementById('app-container');
            if (!appContainer) return;
            appContainer.innerHTML = '';
            
            if (appState.currentView === 'auth') {
                appContainer.innerHTML = renderAuthView();
            } else {
                const header = `
                    <div class="fixed top-0 left-0 w-full bg-stone-900 shadow-lg p-4 z-20 flex justify-between items-center text-white font-serif">
                        <h1 class="text-2xl">Agenda de Tatuagem</h1>
                        <div class="flex items-center space-x-2">
                             <div class="text-xs bg-stone-700 rounded-full px-2 py-1 truncate max-w-[50%]">
                                ${firebaseReady ? (appState.isPaid ? 'Plano Vital√≠cio' : `Gr√°tis (${appState.appointmentsCount}/10)`) : 'Modo de Demonstra√ß√£o'}
                             </div>
                             <button id="logout-btn" class="text-sm bg-red-600 rounded-full px-4 py-2 hover:bg-red-500 transition-colors">Sair</button>
                        </div>
                    </div>
                `;
                const mainContent = `
                    <div class="pt-20 pb-20 p-4 min-h-screen bg-stone-900 text-gray-300 font-sans">
                        ${appState.currentView === 'agenda' ? renderAgendaView() : renderClientsView()}
                    </div>
                `;
                const footer = `
                    <div class="fixed bottom-0 left-0 w-full bg-stone-900 shadow-lg p-4 z-20 font-serif">
                        <div class="flex justify-around">
                            <button id="tab-agenda" class="p-4 rounded-xl flex-1 mx-2 ${appState.currentView === 'agenda' ? 'bg-stone-700 text-amber-500' : 'text-gray-400 hover:bg-stone-800'} transition-colors">
                                <span class="text-xl">üìÖ</span><br>Agenda
                            </button>
                            <button id="tab-clients" class="p-4 rounded-xl flex-1 mx-2 ${appState.currentView === 'clients' ? 'bg-stone-700 text-amber-500' : 'text-gray-400 hover:bg-stone-800'} transition-colors">
                                <span class="text-xl">üë•</span><br>Clientes
                            </button>
                        </div>
                    </div>
                `;
                appContainer.innerHTML = header + mainContent + footer;
            }

            attachEventListeners();
        }

        function showPaywall() {
            const modal = document.createElement('div');
            modal.id = 'paywall-modal';
            modal.className = "fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300 opacity-100";
            modal.innerHTML = `
                <div class="bg-stone-800 p-6 rounded-xl shadow-2xl w-full max-w-sm text-center font-sans text-gray-300">
                    <h2 class="text-2xl font-serif text-white mb-4">Limite Gratuito Atingido</h2>
                    <p class="mb-4">Para continuar usando a agenda e ter acesso ilimitado, fa√ßa um pagamento √∫nico de R$ 99,90 via PIX.</p>
                    <a href="https://nubank.com.br" target="_blank" class="w-full inline-block p-4 rounded-lg bg-amber-500 text-stone-900 font-bold hover:bg-amber-400 transition-colors">
                        Pagar com PIX
                    </a>
                    <p class="mt-4 text-sm text-gray-400">Ap√≥s o pagamento, sua agenda ser√° liberada em at√© 24 horas.</p>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function renderAuthView() {
            return `
                <div class="flex min-h-screen items-center justify-center p-4 bg-stone-900 font-sans">
                    <div class="bg-stone-800 p-8 rounded-xl shadow-2xl w-full max-w-sm text-gray-300 text-center">
                        <h2 class="text-3xl font-serif text-white mb-6">Bem-vindo</h2>
                        <form id="auth-form" class="space-y-4">
                            <div>
                                <input type="email" id="auth-email" required class="w-full p-3 bg-stone-700 rounded-lg text-white" placeholder="E-mail">
                            </div>
                            <div>
                                <input type="password" id="auth-password" required class="w-full p-3 bg-stone-700 rounded-lg text-white" placeholder="Senha">
                            </div>
                            <div class="flex flex-col space-y-4">
                                <button type="submit" id="login-btn" class="w-full p-3 rounded-lg bg-amber-500 text-stone-900 font-bold hover:bg-amber-400 transition-colors">Entrar</button>
                                <button type="button" id="signup-btn" class="w-full p-3 rounded-lg bg-stone-700 text-white hover:bg-stone-600 transition-colors">Criar Conta</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
        }

        function renderAgendaView() {
            const today = dayjs();
            const startOfMonth = appState.currentDate.startOf('month');
            const endOfMonth = appState.currentDate.endOf('month');
            const startOfWeek = startOfMonth.startOf('week');
            const endOfWeek = endOfMonth.endOf('week');

            const monthName = appState.currentDate.format('MMMM YYYY');
            const dayNames = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];

            let calendarHTML = `<div class="grid grid-cols-7 text-center font-bold text-gray-400 mb-2">`;
            dayNames.forEach(day => calendarHTML += `<div>${day}</div>`);
            calendarHTML += `</div>`;
            
            calendarHTML += `<div class="grid grid-cols-7">`;
            let day = startOfWeek;
            while (day.isBefore(endOfWeek) || day.isSame(endOfWeek)) {
                const dayClass = day.month() === appState.currentDate.month() ? 'text-gray-300' : 'text-gray-500';
                const todayClass = day.isSame(today, 'day') ? 'bg-amber-500 text-white rounded-full' : '';
                const hasAppointment = appState.appointments.some(a => dayjs(a.date).isSame(day, 'day'));
                const dotClass = hasAppointment ? `<span class="absolute -bottom-1 left-1/2 -translate-x-1/2 h-2 w-2 bg-amber-500 rounded-full"></span>` : '';
                
                calendarHTML += `
                    <div class="p-1 text-center relative">
                        <button class="w-full h-10 flex items-center justify-center mx-auto ${dayClass} ${todayClass} hover:bg-stone-700 rounded-full transition-colors" data-day="${day.format('YYYY-MM-DD')}">
                            ${day.format('D')}
                        </button>
                        ${dotClass}
                    </div>
                `;
                day = day.add(1, 'day');
            }
            calendarHTML += `</div>`;

            const selectedDateAppointments = appState.appointments
                .filter(a => dayjs(a.date).isSame(appState.selectedDate, 'day'))
                .sort((a, b) => dayjs(a.date).isBefore(dayjs(b.date)) ? -1 : 1);
            
            const appointmentsList = selectedDateAppointments.length > 0
                ? selectedDateAppointments.map(app => {
                    const client = appState.clients.find(c => c.id === app.clientId);
                    return `
                        <div class="bg-stone-800 p-4 rounded-xl shadow-lg my-4 flex justify-between items-center transition-transform transform hover:scale-105">
                            <div>
                                <h3 class="text-xl font-serif text-amber-500">${dayjs(app.date).format('HH:mm')} - ${client ? client.name : 'Cliente exclu√≠do'}</h3>
                                <p class="text-sm mt-1">${app.bodyPart} | Sinal: ${app.depositPaid ? '‚úÖ' : '‚ùå'}</p>
                                ${app.referenceImage ? `<img src="${app.referenceImage}" alt="Imagem de refer√™ncia" class="w-16 h-16 rounded-lg mt-2 object-cover cursor-pointer" onclick="openImageModal('${app.referenceImage}')">` : ''}
                            </div>
                            <div class="flex space-x-2">
                                <button class="p-2 bg-stone-700 rounded-full text-gray-400 hover:bg-amber-500 hover:text-white transition-colors" data-edit-appointment="${app.id}">
                                    <span class="text-sm">‚úèÔ∏è</span>
                                </button>
                                <button class="p-2 bg-red-800 rounded-full text-white hover:bg-red-600 transition-colors" data-delete-appointment="${app.id}">
                                    <span class="text-sm">üóëÔ∏è</span>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('')
                : `<p class="text-center text-gray-500 mt-8">Nenhum agendamento para este dia.</p>`;

            const clientsOptions = appState.clients.map(client => `<option value="${client.id}">${client.name}</option>`).join('');
            const bodyPartsOptions = bodyParts.map(part => `<option value="${part}">${part}</option>`).join('');

            const appointmentModal = `
                <div id="appointment-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ${appState.isAppointmentModalVisible ? 'opacity-100' : 'opacity-0 invisible'}">
                    <div class="bg-stone-800 p-6 rounded-xl shadow-2xl w-full max-w-sm font-sans text-gray-300">
                        <h2 class="text-2xl font-serif text-white mb-4">${appState.editingAppointment ? 'Editar' : 'Novo'} Agendamento</h2>
                        <form id="appointment-form" class="space-y-4">
                            <div>
                                <label for="appointment-client" class="block text-sm font-bold">Cliente:</label>
                                <select id="appointment-client" required class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white">
                                    <option value="">Selecione um cliente</option>
                                    ${clientsOptions}
                                </select>
                            </div>
                            <div>
                                <label for="appointment-date" class="block text-sm font-bold">Data:</label>
                                <input type="date" id="appointment-date" required class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white">
                            </div>
                            <div>
                                <label for="appointment-time" class="block text-sm font-bold">Hor√°rio:</label>
                                <input type="time" id="appointment-time" required class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white">
                            </div>
                            <div>
                                <label for="appointment-body-part" class="block text-sm font-bold">Local da Tatuagem:</label>
                                <select id="appointment-body-part" required class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white">
                                    <option value="">Selecione a regi√£o do corpo</option>
                                    ${bodyPartsOptions}
                                </select>
                            </div>
                            <div class="flex items-center space-x-2">
                                <input type="checkbox" id="appointment-deposit-paid" class="form-checkbox h-5 w-5 text-amber-500 bg-stone-700 border-gray-600 rounded">
                                <label for="appointment-deposit-paid" class="text-sm font-bold">Sinal Pago</label>
                            </div>
                            <div>
                                <label for="appointment-image" class="block text-sm font-bold">Imagem de Refer√™ncia (URL):</label>
                                <input type="text" id="appointment-image" class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white" placeholder="https://exemplo.com/imagem.png">
                            </div>
                            <div class="flex justify-between mt-6">
                                <button type="button" id="close-appointment-modal" class="px-4 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors">Cancelar</button>
                                <button type="submit" class="px-4 py-2 rounded-lg bg-amber-500 text-stone-900 font-bold hover:bg-amber-400 transition-colors">${appState.editingAppointment ? 'Salvar' : 'Agendar'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            return `
                <div class="space-y-6">
                    <div class="flex justify-between items-center text-white p-2 bg-stone-800 rounded-xl shadow-lg font-serif">
                        <button id="prev-month" class="p-2 rounded-full hover:bg-stone-700 transition-colors">‚óÄ</button>
                        <h2 class="text-xl font-bold">${monthName}</h2>
                        <button id="next-month" class="p-2 rounded-full hover:bg-stone-700 transition-colors">‚ñ∂</button>
                    </div>
                    ${calendarHTML}
                    <h3 class="text-xl font-serif text-white mt-8 mb-4">Agendamentos para ${appState.selectedDate.format('DD [de] MMMM')}</h3>
                    ${appointmentsList}
                    <button id="add-appointment-btn" class="fixed bottom-24 right-4 p-4 rounded-full bg-amber-500 text-stone-900 shadow-lg hover:scale-110 transition-transform z-10">
                        <span class="text-3xl">+</span>
                    </button>
                    ${appointmentModal}
                </div>
            `;
        }

        function renderClientsView() {
            const clientList = appState.clients.length > 0
                ? appState.clients.map(client => `
                    <div class="bg-stone-800 p-4 rounded-xl shadow-lg my-4 flex justify-between items-center transition-transform transform hover:scale-105">
                        <div>
                            <h3 class="text-xl font-serif text-amber-500">${client.name}</h3>
                            <p class="text-sm text-gray-400">Contato: ${client.contact}</p>
                            <p class="text-sm text-gray-400">Valor Total: ${client.totalValue}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button class="p-2 bg-stone-700 rounded-full text-gray-400 hover:bg-amber-500 hover:text-white transition-colors" data-edit-client="${client.id}">
                                <span class="text-sm">‚úèÔ∏è</span>
                            </button>
                            <button class="p-2 bg-red-800 rounded-full text-white hover:bg-red-600 transition-colors" data-delete-client="${client.id}">
                                <span class="text-sm">üóëÔ∏è</span>
                            </button>
                        </div>
                    </div>
                `).join('')
                : `<p class="text-center text-gray-500 mt-8">Nenhum cliente cadastrado.</p>`;

            const clientModal = `
                <div id="client-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4 transition-opacity duration-300 ${appState.isClientFormVisible ? 'opacity-100' : 'opacity-0 invisible'}">
                    <div class="bg-stone-800 p-6 rounded-xl shadow-2xl w-full max-w-sm font-sans text-gray-300">
                        <h2 class="text-2xl font-serif text-white mb-4">${appState.editingClient ? 'Editar' : 'Novo'} Cliente</h2>
                        <form id="client-form" class="space-y-4">
                            <div>
                                <label for="client-name" class="block text-sm font-bold">Nome:</label>
                                <input type="text" id="client-name" required class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white" placeholder="Nome do Cliente">
                            </div>
                            <div>
                                <label for="client-contact" class="block text-sm font-bold">Contato (Email/Telefone):</label>
                                <input type="text" id="client-contact" required class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white" placeholder="Email ou Telefone">
                            </div>
                            <div>
                                <label for="client-value" class="block text-sm font-bold">Valor Total:</label>
                                <input type="number" id="client-value" required class="w-full mt-1 p-2 bg-stone-700 rounded-lg text-white" placeholder="Valor total da tatuagem">
                            </div>
                            <div class="flex justify-between mt-6">
                                <button type="button" id="close-client-modal" class="px-4 py-2 rounded-lg bg-gray-600 text-white hover:bg-gray-500 transition-colors">Cancelar</button>
                                <button type="submit" class="px-4 py-2 rounded-lg bg-amber-500 text-stone-900 font-bold hover:bg-amber-400 transition-colors">${appState.editingClient ? 'Salvar' : 'Adicionar'}</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            
            return `
                <div>
                    <h2 class="text-2xl font-serif text-white mb-4">Lista de Clientes</h2>
                    ${clientList}
                    <button id="add-client-btn" class="fixed bottom-24 right-4 p-4 rounded-full bg-amber-500 text-stone-900 shadow-lg hover:scale-110 transition-transform z-10">
                        <span class="text-3xl">+</span>
                    </button>
                    ${clientModal}
                </div>
            `;
        }
        
        // Listeners de eventos
        function attachEventListeners() {
            const appContainer = document.getElementById('app-container');

            if (appState.currentView === 'auth') {
                const authForm = document.getElementById('auth-form');
                if (authForm) {
                    authForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        if (!firebaseReady) {
                             showNotification('Modo de demonstra√ß√£o: o login n√£o funciona.', 'error');
                             // Simula login de sucesso para mostrar a interface
                             userId = 'demo-user-id';
                             appState.currentView = 'agenda';
                             fetchClients();
                             fetchAppointments();
                             render();
                             return;
                        }
                        const email = document.getElementById('auth-email').value;
                        const password = document.getElementById('auth-password').value;
                        try {
                            await signInWithEmailAndPassword(auth, email, password);
                        } catch (error) {
                            if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                                showNotification('E-mail ou senha inv√°lidos.', 'error');
                            } else {
                                showNotification(`Erro ao fazer login: ${error.message}`, 'error');
                            }
                        }
                    });

                    const signupBtn = document.getElementById('signup-btn');
                    if (signupBtn) {
                        signupBtn.addEventListener('click', async () => {
                            if (!firebaseReady) {
                                return showNotification('Modo de demonstra√ß√£o: a cria√ß√£o de conta n√£o funciona.', 'error');
                            }
                            const email = document.getElementById('auth-email').value;
                            const password = document.getElementById('auth-password').value;
                            if (password.length < 6) {
                                return showNotification('A senha deve ter pelo menos 6 caracteres.', 'error');
                            }
                            try {
                                await createUserWithEmailAndPassword(auth, email, password);
                                await setDoc(doc(db, `artifacts/${appId}/users/${auth.currentUser.uid}/private/profile`), { isPaid: false });
                                showNotification('Conta criada com sucesso! Fa√ßa o login.');
                            } catch (error) {
                                if (error.code === 'auth/email-already-in-use') {
                                    showNotification('Este e-mail j√° est√° em uso.', 'error');
                                } else {
                                    showNotification(`Erro ao criar conta: ${error.message}`, 'error');
                                }
                            }
                        });
                    }
                }
            } else {
                const logoutBtn = appContainer.querySelector('#logout-btn');
                if (logoutBtn) logoutBtn.addEventListener('click', () => {
                    if (firebaseReady) {
                        signOut(auth);
                    } else {
                        userId = null;
                        appState.currentView = 'auth';
                        render();
                    }
                });
                
                const tabAgenda = appContainer.querySelector('#tab-agenda');
                if (tabAgenda) tabAgenda.addEventListener('click', () => { appState.currentView = 'agenda'; render(); });
                const tabClients = appContainer.querySelector('#tab-clients');
                if (tabClients) tabClients.addEventListener('click', () => { appState.currentView = 'clients'; render(); });
                
                if (appState.currentView === 'agenda') {
                    const calendarDays = appContainer.querySelectorAll('[data-day]');
                    calendarDays.forEach(dayBtn => dayBtn.addEventListener('click', () => { appState.selectedDate = dayjs(dayBtn.dataset.day); render(); }));
                    
                    const prevMonthBtn = appContainer.querySelector('#prev-month');
                    if (prevMonthBtn) prevMonthBtn.addEventListener('click', () => { appState.currentDate = appState.currentDate.subtract(1, 'month'); render(); });
                    const nextMonthBtn = appContainer.querySelector('#next-month');
                    if (nextMonthBtn) nextMonthBtn.addEventListener('click', () => { appState.currentDate = appState.currentDate.add(1, 'month'); render(); });

                    const addAppointmentBtn = document.getElementById('add-appointment-btn');
                    if (addAppointmentBtn) {
                        addAppointmentBtn.addEventListener('click', () => {
                            appState.editingAppointment = null;
                            appState.isAppointmentModalVisible = true;
                            render();
                            const dateInput = document.getElementById('appointment-date');
                            if (dateInput) dateInput.value = appState.selectedDate.format('YYYY-MM-DD');
                        });
                    }
                    
                    const appointmentForm = document.getElementById('appointment-form');
                    if (appointmentForm) {
                        appointmentForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const data = {
                                clientId: document.getElementById('appointment-client').value,
                                date: dayjs(`${document.getElementById('appointment-date').value}T${document.getElementById('appointment-time').value}`).toISOString(),
                                bodyPart: document.getElementById('appointment-body-part').value,
                                depositPaid: document.getElementById('appointment-deposit-paid').checked,
                                referenceImage: document.getElementById('appointment-image').value
                            };
                            if (appState.editingAppointment) data.id = appState.editingAppointment.id;
                            saveAppointment(data);
                            appState.isAppointmentModalVisible = false;
                            render();
                        });
                    }
                    
                    const closeAppointmentModal = document.getElementById('close-appointment-modal');
                    if (closeAppointmentModal) closeAppointmentModal.addEventListener('click', () => { appState.isAppointmentModalVisible = false; render(); });
                    
                    document.querySelectorAll('[data-delete-appointment]').forEach(btn => btn.addEventListener('click', (e) => { if (confirm('Tem certeza?')) deleteAppointment(e.currentTarget.dataset.deleteAppointment); }));
                    document.querySelectorAll('[data-edit-appointment]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            appState.editingAppointment = appState.appointments.find(a => a.id === e.currentTarget.dataset.editAppointment);
                            appState.isAppointmentModalVisible = true;
                            render();
                            const form = document.getElementById('appointment-form');
                            if (form && appState.editingAppointment) {
                                form.querySelector('#appointment-client').value = appState.editingAppointment.clientId;
                                form.querySelector('#appointment-date').value = dayjs(appState.editingAppointment.date).format('YYYY-MM-DD');
                                form.querySelector('#appointment-time').value = dayjs(appState.editingAppointment.date).format('HH:mm');
                                form.querySelector('#appointment-body-part').value = appState.editingAppointment.bodyPart;
                                form.querySelector('#appointment-deposit-paid').checked = appState.editingAppointment.depositPaid;
                                form.querySelector('#appointment-image').value = appState.editingAppointment.referenceImage;
                            }
                        });
                    });

                } else if (appState.currentView === 'clients') {
                    const addClientBtn = document.getElementById('add-client-btn');
                    if (addClientBtn) addClientBtn.addEventListener('click', () => { appState.editingClient = null; appState.isClientFormVisible = true; render(); });
                    
                    const clientForm = document.getElementById('client-form');
                    if (clientForm) {
                        clientForm.addEventListener('submit', (e) => {
                            e.preventDefault();
                            const data = {
                                name: document.getElementById('client-name').value,
                                contact: document.getElementById('client-contact').value,
                                totalValue: document.getElementById('client-value').value
                            };
                            if (appState.editingClient) data.id = appState.editingClient.id;
                            saveClient(data);
                            appState.isClientFormVisible = false;
                            render();
                        });
                    }
                    
                    const closeClientModal = document.getElementById('close-client-modal');
                    if (closeClientModal) closeClientModal.addEventListener('click', () => { appState.isClientFormVisible = false; render(); });
                    
                    document.querySelectorAll('[data-delete-client]').forEach(btn => btn.addEventListener('click', (e) => { if (confirm('Tem certeza?')) deleteClient(e.currentTarget.dataset.deleteClient); }));
                    document.querySelectorAll('[data-edit-client]').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            appState.editingClient = appState.clients.find(c => c.id === e.currentTarget.dataset.editClient);
                            appState.isClientFormVisible = true;
                            render();
                            const form = document.getElementById('client-form');
                            if (form && appState.editingClient) {
                                form.querySelector('#client-name').value = appState.editingClient.name;
                                form.querySelector('#client-contact').value = appState.editingClient.contact;
                                form.querySelector('#client-value').value = appState.editingClient.totalValue;
                            }
                        });
                    });
                }
            }
        }
        
        if (firebaseReady) {
             onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    appState.currentView = 'agenda';
                    if (!appState.isLoaded) {
                        await fetchPaymentStatus();
                        await fetchClients();
                        await fetchAppointments();
                        appState.isLoaded = true;
                    }
                } else {
                    userId = null;
                    appState.currentView = 'auth';
                    appState.isLoaded = false;
                }
                render();
            });
        } else {
             onAuthStateChanged({onAuthStateChanged: (user) => {
                if (user) {
                    userId = user.uid;
                    appState.currentView = 'agenda';
                    if (!appState.isLoaded) {
                        fetchClients();
                        fetchAppointments();
                        appState.isLoaded = true;
                    }
                } else {
                    userId = null;
                    appState.currentView = 'auth';
                    appState.isLoaded = false;
                }
                render();
            }});
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            render();
        });
    </script>
</body>
</html>

